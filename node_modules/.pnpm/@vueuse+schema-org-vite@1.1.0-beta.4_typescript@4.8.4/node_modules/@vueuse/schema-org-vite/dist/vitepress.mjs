import { resolveUserConfig, createSchemaOrg } from '@vueuse/schema-org';
import { createHead } from '@vueuse/head';
import { watch } from 'vue';

function installSchemaOrg(ctx, config) {
  const resolvedConfig = resolveUserConfig(config);
  let head = ctx.app._context.provides.usehead;
  if (!head) {
    head = createHead();
    ctx.app.use(head);
  }
  const client = createSchemaOrg({
    meta() {
      return {
        path: ctx.router.route.path,
        ...ctx.siteData.value,
        ...ctx.router.route.data,
        ...ctx.router.route.data.frontmatter,
        ...resolvedConfig.meta
      };
    },
    updateHead(fn) {
      head.addHeadObjs(fn);
      if (typeof document !== "undefined")
        head.updateDOM();
    }
  });
  watch(() => ctx.router.route.data.relativePath, () => {
    client.generateSchema();
  });
  ctx.app.use(client);
  client.setupDOM();
  return client;
}

export { installSchemaOrg };
